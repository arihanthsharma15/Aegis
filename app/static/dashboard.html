<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aegis Security Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #09111f;
      --panel: #111d33;
      --panel-2: #162744;
      --text: #eaf0ff;
      --muted: #a8b5d9;
      --accent: #28c0ff;
      --danger: #ff5a67;
      --warn: #ffba49;
      --ok: #28d17c;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      color: var(--text);
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 80% 0%, #1c2f57 0%, transparent 40%),
        radial-gradient(circle at 0% 100%, #153659 0%, transparent 38%),
        var(--bg);
    }

    h1 { margin: 0 0 8px; letter-spacing: 0.02em; }
    p { margin: 0; color: var(--muted); }

    .toolbar {
      margin-top: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--muted);
    }

    select {
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 0.92rem;
    }

    .grid {
      margin-top: 20px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .card {
      background: linear-gradient(145deg, var(--panel), var(--panel-2));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .metric-label { color: var(--muted); font-size: 0.92rem; }
    .metric-value { font-size: 2rem; font-weight: 700; margin-top: 8px; }
    .metric-sub { color: var(--muted); font-size: 0.78rem; margin-top: 6px; }

    .section {
      margin-top: 18px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }

    .wide { grid-column: 1 / -1; }
    canvas { width: 100% !important; height: 280px !important; }

    ul { margin: 10px 0 0; padding-left: 18px; color: var(--muted); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.92rem;
      color: var(--muted);
    }

    th, td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.76rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .pill.low { background: rgba(40, 209, 124, 0.15); color: var(--ok); }
    .pill.medium { background: rgba(255, 186, 73, 0.15); color: var(--warn); }
    .pill.high { background: rgba(255, 90, 103, 0.15); color: var(--danger); }
  </style>
</head>
<body>
  <h1>Aegis API Dashboard</h1>
  <p>Production-grade Redis-backed metrics with persistent history.</p>

  <div class="toolbar">
    <label for="historySelect">History range</label>
    <select id="historySelect">
      <option value="30">Last 30 minutes</option>
      <option value="360">Last 6 hours</option>
      <option value="1440">Last 24 hours</option>
      <option value="10080">Last 7 days</option>
    </select>
    <span id="retentionInfo"></span>
  </div>

  <div class="grid">
    <div class="card">
      <div class="metric-label">Requests / minute (latest active)</div>
      <div class="metric-value" id="rpm">0</div>
      <div class="metric-sub" id="rpmCurrent">current minute: 0</div>
    </div>
    <div class="card">
      <div class="metric-label">Blocked / minute (latest active)</div>
      <div class="metric-value" id="blocked">0</div>
      <div class="metric-sub" id="blockedCurrent">current minute: 0</div>
    </div>
    <div class="card">
      <div class="metric-label">Rate-limit hits / minute (latest active)</div>
      <div class="metric-value" id="rateHits">0</div>
      <div class="metric-sub" id="rateHitsCurrent">current minute: 0</div>
    </div>
    <div class="card"><div class="metric-label">Redis connected clients</div><div class="metric-value" id="redisClients">0</div></div>
  </div>

  <div class="section">
    <div class="card"><h3>Traffic Trend</h3><canvas id="trafficChart"></canvas></div>
    <div class="card"><h3>Rate Limit vs Blocked</h3><canvas id="blockedChart"></canvas></div>
    <div class="card wide">
      <h3>FastAPI + Redis Stats</h3>
      <div class="grid">
        <div class="card"><div class="metric-label">FastAPI uptime (s)</div><div class="metric-value" id="uptime">0</div></div>
        <div class="card"><div class="metric-label">Redis memory (MB)</div><div class="metric-value" id="redisMem">0</div></div>
        <div class="card"><div class="metric-label">Redis ops/sec</div><div class="metric-value" id="redisOps">0</div></div>
        <div class="card"><div class="metric-label">Cache hit/miss</div><div class="metric-value" id="redisHitMiss">0 / 0</div></div>
      </div>
    </div>

    <div class="card">
      <h3>Stack Suggestion</h3>
      <div id="riskPill" class="pill low">low</div>
      <ul id="suggestions"></ul>
    </div>

    <div class="card">
      <h3>Attack Simulation Results</h3>
      <table>
        <thead>
          <tr>
            <th>Run At</th>
            <th>Total</th>
            <th>Blocked</th>
            <th>Success</th>
            <th>Avg 200 (ms)</th>
            <th>P95 (ms)</th>
          </tr>
        </thead>
        <tbody id="attackTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    const historySelect = document.getElementById("historySelect");
    const retentionInfo = document.getElementById("retentionInfo");

    const trafficChartCtx = document.getElementById("trafficChart").getContext("2d");
    const blockedChartCtx = document.getElementById("blockedChart").getContext("2d");

    const trafficChart = new Chart(trafficChartCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Requests/min",
          data: [],
          borderColor: "#28c0ff",
          backgroundColor: "rgba(40, 192, 255, 0.15)",
          fill: true,
          tension: 0.2,
          pointRadius: 0,
        }],
      },
      options: { responsive: true, maintainAspectRatio: false },
    });

    const blockedChart = new Chart(blockedChartCtx, {
      type: "bar",
      data: {
        labels: [],
        datasets: [
          {
            label: "Blocked",
            data: [],
            backgroundColor: "rgba(255, 90, 103, 0.7)",
          },
          {
            label: "Rate-limit hits",
            data: [],
            backgroundColor: "rgba(255, 186, 73, 0.7)",
          },
        ],
      },
      options: { responsive: true, maintainAspectRatio: false },
    });

    function setText(id, value) {
      const element = document.getElementById(id);
      if (element) element.textContent = value;
    }

    function renderAttackTable(rows) {
      const body = document.getElementById("attackTable");
      body.innerHTML = "";
      rows.slice(0, 6).forEach((row) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.run_at}</td>
          <td>${row.total_requests}</td>
          <td>${row.blocked_count}</td>
          <td>${row.success_count}</td>
          <td>${Math.round(row.avg_success_latency_ms || 0)}</td>
          <td>${Math.round(row.p95_latency_ms)}</td>
        `;
        body.appendChild(tr);
      });
    }

    function renderSuggestions(suggestion) {
      const riskPill = document.getElementById("riskPill");
      riskPill.className = `pill ${suggestion.risk_level}`;
      riskPill.textContent = suggestion.risk_level;

      const list = document.getElementById("suggestions");
      list.innerHTML = "";
      suggestion.recommendations.forEach((text) => {
        const li = document.createElement("li");
        li.textContent = text;
        list.appendChild(li);
      });
    }

    async function refreshDashboard() {
      try {
        const historyMinutes = historySelect.value;
        const response = await fetch(`/metrics/dashboard?history_minutes=${historyMinutes}`);
        const data = await response.json();

        setText("rpm", data.requests_per_minute_latest_active);
        setText("blocked", data.blocked_requests_per_minute_latest_active);
        setText("rateHits", data.rate_limit_hits_per_minute_latest_active);
        setText("rpmCurrent", `current minute: ${data.requests_per_minute}`);
        setText("blockedCurrent", `current minute: ${data.blocked_requests_per_minute}`);
        setText("rateHitsCurrent", `current minute: ${data.rate_limit_hits_per_minute}`);

        setText("redisClients", data.redis.connected_clients);
        setText("uptime", data.fastapi.uptime_seconds);
        setText("redisMem", data.redis.used_memory_mb);
        setText("redisOps", data.redis.instantaneous_ops_per_sec);
        setText("redisHitMiss", `${data.redis.keyspace_hits} / ${data.redis.keyspace_misses}`);

        retentionInfo.textContent = `retention: ${data.history_retention_minutes} minutes`;

        trafficChart.data.labels = data.series.requests.labels;
        trafficChart.data.datasets[0].data = data.series.requests.values;
        trafficChart.update();

        blockedChart.data.labels = data.series.blocked.labels;
        blockedChart.data.datasets[0].data = data.series.blocked.values;
        blockedChart.data.datasets[1].data = data.series.rate_limit_hits.values;
        blockedChart.update();

        renderAttackTable(data.attack_simulation_results || []);
        renderSuggestions(data.stack_suggestion);
      } catch (error) {
        console.error("Dashboard refresh failed", error);
      }
    }

    historySelect.addEventListener("change", refreshDashboard);

    refreshDashboard();
    setInterval(refreshDashboard, 3000);
  </script>
</body>
</html>
