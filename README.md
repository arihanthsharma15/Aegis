# Aegis API - Security & Analytics Middleware

## Overview
**Aegis API** is a proactive API Security and Analytics Middleware built with **FastAPI** and **Redis**.
It protects high-resource and AI-driven applications from abuse, unauthorized access, and sudden traffic spikes while keeping low latency.

Aegis now ships with a **live visibility dashboard** and **Redis-backed persistent metrics history** for production deployments.

## Key Features
- **Sliding Window Rate Limiting** via Redis sorted sets
- **Real-time Security Dashboard** for request analytics and abuse visibility
- **Persistent Historical Metrics** (minute buckets in Redis with retention)
- **Attack Simulation Tracking** with persisted run summaries
- **Redis and FastAPI Runtime Metrics** exposed through API
- **Stack Suggestion Engine** based on observed traffic risk signals

## Tech Stack
- **Backend:** Python, FastAPI
- **Cache & Limiting:** Redis
- **Visualization:** Chart.js dashboard served by FastAPI
- **Containerization:** Docker, Docker Compose
- **Load Testing:** Locust + async attack simulator

## Dashboard Visibility
Open `http://127.0.0.1:8000/dashboard` to view:
- Requests per minute (latest active + current)
- Blocked requests
- Rate-limit hits
- Attack simulation results
- FastAPI backend uptime
- Redis stats (memory, ops/sec, clients, hit/miss)
- Live stack hardening suggestions
- Historical ranges: `30m / 6h / 24h / 7d`

## API Endpoints
- `GET /health`
- `POST /expensive-ai-call`
- `GET /dashboard`
- `GET /metrics/dashboard?history_minutes=30`
- `POST /metrics/attack-simulation`

## Environment Variables
- `REDIS_URL` (default: `redis://localhost:6379`)
- `RATE_LIMIT` (default: `60`)
- `WINDOW_SIZE` (default: `60`)
- `METRICS_RETENTION_MINUTES` (default: `10080` = 7 days)
- `ATTACK_RESULTS_LIMIT` (default: `100`)
- `CORS_ORIGINS` (default: `*`, comma-separated origins in production)

## Attack Simulation
Run:
```bash
python3 scripts/attack_sim.py
```

The script sends concurrent traffic to `/expensive-ai-call`, computes latency/success/block stats, and pushes the result to `/metrics/attack-simulation` for dashboard visualization.

Production-friendly env options:
- `AEGIS_BASE_URL` (default: `http://127.0.0.1:8000`)
- `ATTACK_TOTAL_REQUESTS` (default: `20`)
- `ATTACK_CONCURRENCY` (default: `3`)

## Deploy For Live Link
1. Deploy FastAPI backend to Render/Railway/Fly.
2. Attach managed Redis (Render Redis, Upstash, Railway Redis).
3. Set required environment variables.
4. Start command:
   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port $PORT
   ```
5. Open live dashboard at:
   ```
   https://<your-domain>/dashboard
   ```

## Automate Demo Traffic (Railway Cron)
To keep dashboard data fresh for viewers without running locally:
1. Create a second Railway service from same repo (e.g. `aegis-simulator`).
2. Set Start Command:
   ```bash
   python3 scripts/attack_sim.py
   ```
3. Set variables:
   - `AEGIS_BASE_URL=https://<your-public-domain>`
   - `ATTACK_TOTAL_REQUESTS=20`
   - `ATTACK_CONCURRENCY=3`
4. Add a Cron schedule (e.g. every 15 or 30 minutes).

## Demo Note
- Automated synthetic attack traffic is intentionally enabled for demo observability.
- Dashboard spikes and blocked requests are generated by scheduled simulator runs to demonstrate rate-limiter behavior end-to-end.

## Project Structure
```text
app/
|- api/           # API endpoints
|- core/          # Config and logger
|- middleware/    # Rate limiting logic
|- services/      # Redis and metrics services
|- static/        # Dashboard frontend (Chart.js)

aegis_middleware/ # Reusable middleware package
examples/         # Demo FastAPI apps
scripts/          # Attack simulation scripts
locustfile.py     # Load testing configuration
```
